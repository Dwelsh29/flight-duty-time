<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/> <title>Wingman Flight/Duty–Rest Calculator</title> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"> <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<style>
  :root{ --bg:#0a1b2a; --card:#112235; --muted:#94a3b8; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --text:#e5e7eb; --input:#0f2841; --border:#1f364d; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:16px}
  .title{font-weight:700;font-size:24px;margin:0 0 4px}
  .subtitle{color:var(--muted);margin:0 0 16px}

  /* Grid: minmax prevents overflow on small devices */
  .grid{display:grid;gap:12px;grid-template-columns:repeat(12, minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input,select{width:100%;max-width:100%;background:var(--input);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:10px 12px;font-size:16px;outline:none}
  .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
  .btn{display:inline-block;border:1px solid var(--border);background:#11314f;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn:hover{filter:brightness(1.1)}
  .btn.alt{background:#142a40}
  .status{border-radius:12px;padding:14px 16px;font-weight:700;margin-bottom:12px}
  .ok{background:rgba(22,163,74,.15);border:1px solid rgba(22,163,74,.35);color:#86efac}
  .warn{background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.35);color:#fde68a}
  .bad{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.35);color:#fecaca}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0f2841;color:var(--text);font-size:12px;margin-right:6px}
  .disclaimer{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}

  /* Mobile layout fix */
  @media (max-width: 420px){
    .wrap{ padding:12px }
    .card{ padding:12px; border-radius:10px }
    .title{ font-size:20px }

    /* Stack columns on small screens */
    .col-6, .col-4, .col-3 { grid-column: span 12; }

    /* Tighter spacing + iOS zoom-safe inputs */
    .row{ gap:8px }
    input,select{ padding:9px 10px; font-size:16px; max-width:100% }
    .btn{ padding:9px 12px }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1 class="title">Wingman Flight / Duty–Rest Calculator</h1>
  <p class="subtitle">Advisory calculator for quick legality checks. <span class="muted">Always verify against regs/ops specs.</span></p>

  <div class="card status ok" id="statusBox">
    <div id="statusLabel">READY</div>
    <div id="statusMsg" class="muted" style="margin-top:4px">Enter duty and flight details, then press <b>Compute</b>.</div>
  </div>

  <div class="grid">
    <div class="col-6 card">
      <label for="ruleSet">Rule set</label>
      <select id="ruleSet">
        <option value="91">Part 91 (Advisory)</option>
        <option value="135">Part 135 (Baseline)</option>
        <option value="121">Part 121 (Simplified)</option>
      </select>
      <div class="row" style="margin-top:12px">
        <span class="pill" id="pillDuty">Max duty: —</span>
        <span class="pill" id="pillFlight">Max flight/24h: —</span>
        <span class="pill" id="pillRest">Min rest: —</span>
      </div>
    </div>

    <div class="col-6 card">
      <label for="crewType">Crew type</label>
      <select id="crewType">
        <option value="single">Single-pilot</option>
        <option value="two">Two-pilot</option>
        <option value="augmented">Augmented</option>
      </select>
      <label for="segments" style="margin-top:10px">Number of segments (legs)</label>
      <input id="segments" type="number" min="1" value="1"/>
    </div>

    <div class="col-6 card">
      <label>Duty start (local)</label>
      <input id="dutyStart" type="datetime-local">
      <label style="margin-top:10px">Duty end (local)</label>
      <input id="dutyEnd" type="datetime-local">
    </div>

    <div class="col-6 card">
      <label>Total block (flight time) hh:mm</label>
      <input id="blockHhmm" type="text" inputmode="numeric" placeholder="e.g. 07:30" pattern="^\\d{1,2}:[0-5]\\d$">
      <div class="grid" style="margin-top:10px">
        <div class="col-6">
          <label>First flight OUT (optional)</label>
          <input id="firstOut" type="datetime-local">
        </div>
        <div class="col-6">
          <label>Last flight IN (optional)</label>
          <input id="lastIn" type="datetime-local">
        </div>
      </div>
    </div>

    <div class="col-12 card">
      <div class="row">
        <button class="btn" id="computeBtn" onclick="compute()">Compute</button>
        <button class="btn alt" id="resetBtn" onclick="resetAll()">Reset</button>
      </div>
      <div id="results" style="margin-top:14px">
        <div class="muted">Results will appear here.</div>
      </div>
      <p class="disclaimer" style="margin-top:12px">
        This tool is a simplified advisory aid. It does not implement full FAR 117/135 tables, extensions, acclimation, FDP start time adjustments,
        unforeseen operational circumstances, or company/CBA limits. PIC remains responsible for compliance.
      </p>
    </div>
  </div>

  <!-- Info box -->
  <div style="background:#112235;color:#e5e7eb;border:1px solid #1f364d;border-radius:12px;padding:16px;line-height:1.45;margin-top:16px;">
    <div style="font-weight:700;margin-bottom:6px;">How to use this tool</div>
    <ul style="margin:0 0 8px 18px;padding:0;">
      <li>Enter <b>Duty Start / Duty End</b> in local time.</li>
      <li>Add <b>total block (flight time)</b> and number of legs.</li>
      <li>Choose <b>rule set</b> (Part 91 = advisory only; Part 135/121 = simplified limits).</li>
      <li>Tap <b>Compute</b> to check legality.</li>
    </ul>
    <div style="font-size:12px;color:#94a3b8;">
      <b>Note:</b> “Simplified” applies baseline FAA duty/rest limits. It does <b>not</b> include full FAR 117 tables,
      grace periods, acclimation, unforeseen operational circumstances, or company/CBA extensions. PIC remains responsible for compliance.
    </div>
  </div>
</div>

<script>
  const DateTime = luxon.DateTime;
  const PROX_THRESHOLD_MIN = 30; // 30-minute buffer for yellow warnings

  // Rule presets (minutes)
  const presets = {
    "91": { maxDutyMin:null, maxFlightMin24:null, minRestMin:null, label:"Part 91 Advisory" },
    "135": { maxDutyMin: 14*60, maxFlightMin24: 10*60, minRestMin: 10*60, label:"Part 135 Baseline" },
    "121": { maxDutyMin: 14*60, maxFlightMin24:  9*60, minRestMin: 10*60, label:"Part 121 Simplified" }
  };

  const el = id=>document.getElementById(id);
  const statusBox = el('statusBox'), statusLabel = el('statusLabel'), statusMsg = el('statusMsg');
  const pillDuty = el('pillDuty'), pillFlight = el('pillFlight'), pillRest = el('pillRest');

  function fmtHM(mins){ if(mins==null) return "—"; const h=Math.floor(mins/60),m=Math.abs(mins%60); return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
  function setPresetPills(key){ const p=presets[key]; pillDuty.textContent=`Max duty: ${fmtHM(p.maxDutyMin)}`; pillFlight.textContent=`Max flight/24h: ${fmtHM(p.maxFlightMin24)}`; pillRest.textContent=`Min rest: ${fmtHM(p.minRestMin)}`; }
  setPresetPills(el('ruleSet').value);
  el('ruleSet').addEventListener('change', e=> setPresetPills(e.target.value));

  function parseHM(txt){ if(!txt) return null; const m=txt.trim().match(/^(\d{1,2}):([0-5]\d)$/); if(!m) return null; return parseInt(m[1],10)*60 + parseInt(m[2],10); }

  function setStatus(css, head, html){ statusBox.classList.remove('ok','warn','bad'); statusBox.classList.add(css); statusLabel.textContent=head; statusMsg.innerHTML=html; }

  // Split violations, proximity warnings, and notes
  function classify(ruleKey, dutyMin, blockMin, firstOut, lastIn){
    const p = presets[ruleKey];
    let violations = [], warnings = [], notes = [];

    if (p.maxDutyMin!=null){
      if (dutyMin > p.maxDutyMin)  violations.push(`Duty ${fmtHM(dutyMin)} exceeds limit ${fmtHM(p.maxDutyMin)}`);
      else if (p.maxDutyMin - dutyMin <= PROX_THRESHOLD_MIN) warnings.push(`Approaching limit: duty is within ${fmtHM(p.maxDutyMin - dutyMin)} of ${fmtHM(p.maxDutyMin)}`);
    }

    if (p.maxFlightMin24!=null){
      if (blockMin > p.maxFlightMin24) violations.push(`Flight time ${fmtHM(blockMin)} exceeds ${fmtHM(p.maxFlightMin24)} in 24h`);
      else if (p.maxFlightMin24 - blockMin <= PROX_THRESHOLD_MIN) warnings.push(`Approaching limit: flight time is within ${fmtHM(p.maxFlightMin24 - blockMin)} of ${fmtHM(p.maxFlightMin24)}`);
    }

    if (firstOut && lastIn){
      const spanMin = Math.round(lastIn.diff(firstOut,'minutes').minutes);
      if (spanMin > 24*60) notes.push(`Flight span ${fmtHM(spanMin)} exceeds 24h window (check rolling limits)`);
    }

    if (p.minRestMin!=null) notes.push(`Minimum rest required before next duty: ${fmtHM(p.minRestMin)}`);

    let status='ok', headline=(ruleKey==='91'?'ADVISORY':'LEGAL');
    if (ruleKey!=='91'){
      if (violations.length>0){ status='bad'; headline='NOT LEGAL'; }
      else if (warnings.length>0){ status='warn'; headline='WARNING'; }
    }

    return {status, headline, violations, warnings, notes};
  }

  // Expose functions globally for inline onclick
  window.compute = function compute(){
    const rule = el('ruleSet').value;

    const dsVal = el('dutyStart').value, deVal = el('dutyEnd').value;
    if(!dsVal || !deVal){ setStatus('warn','MISSING INPUT','Enter <b>Duty start</b> and <b>Duty end</b>.'); el('results').innerHTML='<span class="muted">—</span>'; return; }
    const dutyStart = DateTime.fromISO(dsVal); const dutyEnd = DateTime.fromISO(deVal);
    if(!dutyStart.isValid || !dutyEnd.isValid || dutyEnd<=dutyStart){ setStatus('warn','INVALID TIME','Check that duty end is after duty start.'); el('results').innerHTML='<span class="muted">—</span>'; return; }
    const dutyMin = Math.round(dutyEnd.diff(dutyStart,'minutes').minutes);

    const blockMin = parseHM(el('blockHhmm').value);
    if(blockMin==null){ setStatus('warn','MISSING INPUT','Enter <b>Total block</b> as HH:MM (e.g. 07:30).'); el('results').innerHTML='<span class="muted">—</span>'; return; }

    const firstOut = el('firstOut').value ? DateTime.fromISO(el('firstOut').value) : null;
    const lastIn   = el('lastIn').value   ? DateTime.fromISO(el('lastIn').value)   : null;

    const res = classify(rule, dutyMin, blockMin, firstOut, lastIn);

    const detailList = []
      .concat(res.violations.map(x=>`<li>${x}</li>`))
      .concat(res.warnings.map(x=>`<li>${x}</li>`))
      .concat(res.notes.map(x=>`<li>${x}</li>`))
      .join('');

    const details = `
      <div class="row">
        <div class="pill">Duty: <span class="mono">${fmtHM(dutyMin)}</span></div>
        <div class="pill">Block: <span class="mono">${fmtHM(blockMin)}</span></div>
      </div>
      <ul style="margin:10px 0 0 16px">${detailList}</ul>
    `;
    setStatus(res.status, res.headline, details);

    const spanTxt = (firstOut && lastIn) ? lastIn.diff(firstOut,'hours').toFormat("h' h 'mm' m'") : '—';
    el('results').innerHTML = `
      <div class="card">
        <div><b>Rule set:</b> ${presets[rule].label}</div>
        <div class="muted" style="margin-top:6px">Flight span (if provided): ${spanTxt}</div>
      </div>`;
  };

  window.resetAll = function resetAll(){
    ['dutyStart','dutyEnd','blockHhmm','firstOut','lastIn'].forEach(id=> el(id).value='');
    el('segments').value='1'; el('ruleSet').value='91'; el('crewType').value='single';
    setPresetPills('91');
    setStatus('ok','READY','Enter duty and flight details, then press <b>Compute</b>.');
    el('results').innerHTML='<div class="muted">Results will appear here.</div>';
  };
</script>
</body>
</html>

